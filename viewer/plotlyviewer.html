<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
    .plot {
        height: 400px;
        width: 45%;
        float: left;
    }
    </style>
</head>
<body>
    <div id="cdata" class="plot"></div>
    <div id="wdata" class="plot"></div>
    <div id="cfiltered" class="plot"></div>
    <div id="wfiltered" class="plot"></div>
    <div id="cam" class="plot"></div>
    <div id="world" class="plot"></div>
    <div id="v" class="plot"></div>
    <script>
        var worldLayout = {
            margin: { t: 0 },
            line: {
                width: 20
            }
        }

        // fetch('../data/F3JVH-cam.json').then(function(response) {
        fetch('../data/F3LVDV-cam.json').then(function(response) {
            return response.json()
        }).then(function(data) {
            var points = data.points.slice(400,750);
            console.log(data);
            var cdata = process(points, indentity());
            var cfiltered = process(points, lowPass(0.1));
            var wdata = cdata.map(homography(data.M));
            var wfiltered = cfiltered.map(homography(data.M));
            var wvelocity = wfiltered.map(function(p,i) {
                if (i==0) return 0;
                return Math.sqrt(distance2(p, wfiltered[i-1]));
            }).reduce(lowPass(0.05), [])
            .map((v,i) => [i,v]);
            console.log(wvelocity);
            plot('cdata',toSeries(cdata));
            plot('wdata',toSeries(wdata));
            plot('cfiltered',toSeries(cfiltered));
            plot('wfiltered',toSeries(wfiltered));
            plot('cam',toScatter(cfiltered));
            plot('world',toScatter(wfiltered), worldLayout);
            plot('v',toScatter(wvelocity));
        });

        function process(points, filter) {
            return points.reduce(function(points, set, i) {
                //TODO: refactor a bit here
                var best, last = points[points.length-1];
                if (last) {
                    var filteredSet = set.map(function(candidate) {
                        return [
                            filter([last[0]], candidate[0]).pop(),
                            filter([last[1]], candidate[1]).pop()
                        ];
                    });
                    best = filteredSet.sort(byDistanceTo(last))[0];
                } else {
                    best = set[0];
                }
                return points.concat([best]);
            }, []);
        }

        //converts array of points to two plot.ly series
        function toSeries(points) {
            return points.reduce(function(data, point, index) {
                var s1 = data[0];
                var s2 = data[1];
                s1.x.push(index);
                s1.y.push(point[0]);
                s2.x.push(index);
                s2.y.push(point[1]);
                return data;
            },[{x:[],y:[]},{x:[],y:[]}]);
        }

        function toScatter(points) {
            return points.reduce(function(data, point) {
                var s1 = data[0];
                s1.x.push(point[0]);
                s1.y.push(point[1]);
                return data;
            },[{x:[],y:[]}]);
        }

        function findBest(last, candidates, filter) {

        }

        var allPlots = [];
        function plot(id, data, layout) {
            var el = document.getElementById(id);
            var plot = Plotly.newPlot(
                el,
                data,
                layout || {
                    margin: { t: 0 },
                    xaxis: {
                        // rangeslider: {}
                    },
                },{
                    scrollZoom: true
                }
            );
            allPlots.push(el);
            // el.on('plotly_relayout', function(e) {
            //     var range = e['xaxis.range'];
            //     allPlots.forEach(function(plot) {
            //         Plotly.relayout(plot, {
            //             'xaxis.range': range
            //         });
            //     });
            //     console.log(range);
            // });
            return plot;
        }

        //filters (reducers)
        function indentity() {
            return function(data, datum) {
                return data.concat(datum);
            };
        }

        //lowpass reducer for a single series
        function lowPass(α) {
            return function(data, scalar) {
                var prev = data[data.length-1];
                if (prev) {
                    return data.concat(α * scalar + (1-α) * prev);
                } else {
                    return data.concat(scalar);
                }
            }
        }

        //helpers
        function homography(m) {
            return function(p) {
                p = p.concat(1);
                var r = [
                    dot(m[0],p),
                    dot(m[1],p),
                    dot(m[2],p)
                ];
                return [r[0]/r[2], r[1]/r[2]];
            }
        }

        function diff(p1,p2) {
            return [p1[0]-p2[0],p1[1]-p2[1]];
        }

        function dot(p1,p2) {
            return p1.reduce(function(sum, cc,i) {
                return sum + (p1[i] * p2[i]);
            },0);
        }

        function distance2(p1,p2) {
            var d = diff(p1,p2);
            return d[0]*d[0] + d[1]*d[1];
        }

        //sorter by distance to another point
        function byDistanceTo(target) {
            return function (p1, p2) {
                var d1 = distance2(target, p1);
                var d2 = distance2(target, p2);
                if (d1 === d2) {
                    return 0;
                } else {
                    return (d1 < d2)?-1:1;
                }
            }
        }
    </script>
</body>
</html>